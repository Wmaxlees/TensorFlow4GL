# =========================
# DEFINITIONS
# =========================
'conv_variables': {
    @SAVE 'conv_variables/W'
    @SUMMARIZE histogram test
    @NAME 'filters'
    var filter_variable_1: random_normal ${kernel_size_1} + [1, ${filters_1}]

    @SAVE 'conv_variables/b'
    @SUMMARIZE histogram test
    @NAME 'b'
    var conv_bias_1: zeros (${filters_1}, )
}

'fully_connected_variables': {
    @SAVE 'fully_connected_variables/W_1'
    @NAME 'W_1'
    var W_1: random_normal (${hidden_layer_size_1}, ${hidden_layer_in}, )

    @SAVE 'fully_connected_variables/W_2'
    @NAME 'W_2'
    var W_2: random_normal (1, ${hidden_layer_size_1}, )

    @SAVE 'fully_connected_variables/b_1'
    @NAME 'b_1'
    var b_1: zeros (${hidden_layer_size_1}, )

    @SAVE 'fully_connected_variables/b_2'
    var b_2: zeros (1, )
}

@NAME 'x'
input x: (None, 134, 46, 1, )

@NAME 'y'
@TRUE_LABELS
input y: (None, 1, )

@NAME 'avg_pool'
average_pool as average_pooling_0: ${pool_size_0} ${pool_stride_0}


'conv_1': {
    OP conv2d AS conv_1: (1, 1, 1, 1, )
    OP bias_add AS add_bias
    OP relu6 AS relu_1
    OP batch_norm AS batch_norm_1
    OP dropout AS dropout_1: ${keep_prob_1}
}

OP reduce_mean AS filter_out_1: 3

OP flatten AS flattener
OP tensordot AS fully_connected_layer_1: [[1], [1]]
OP bias_add AS full_bias_1
OP relu6 AS relu_2
OP dropout AS dropout_2: ${keep_prob_2}

OP tensordot AS pre_logits: [[1], [1]]

@OUTPUT 0 test
@PREDICTIONS
OP bias_add AS logits


# =========================
# FILL VARIABLES
# =========================
USE filter_variable_1 IN conv_1
USE conv_bias_1 IN add_bias
USE W_1 IN fully_connected_layer_1
USE b_1 IN full_bias_1
USE W_2 IN pre_logits
USE b_2 IN logits


# =========================
# GENERATE GRAPH
# =========================
PASS x TO average_pooling_0

PASS average_pooling_0 TO conv_1
PASS conv_1 TO add_bias
PASS add_bias TO relu_1
PASS relu_1 TO batch_norm_1
PASS batch_norm_1 TO dropout_1

PASS dropout_1 TO filter_out_1

PASS filter_out_1 TO flattener
PASS flattener TO fully_connected_layer_1
PASS fully_connected_layer_1 TO full_bias_1 
PASS full_bias_1 TO relu_2
PASS relu_2 TO dropout_2

PASS dropout_2 TO pre_logits
PASS pre_logits TO logits


# =========================
# TRAINING DETAILS
# =========================
'xent': {
    @SUMMARIZE histogram train
    @OUTPUT 0 train
    loss sigmoid_cross_entropy
}

@NAME 'training_op'
train adagrad: ${learning_rate}
